<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Doc Viewer Suite</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" id="prism-css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>

    <style>
        :root {
            --bg-app: #f1f5f9;
            --bg-panel: #ffffff;
            --bg-paper: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --accent: #3b82f6;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --header-h: 60px;
            --sidebar-w: 260px;
        }

        html.dark {
            --bg-app: #0f172a;
            --bg-panel: #1e293b;
            --bg-paper: #111;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #60a5fa;
            --border: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- LAYOUT --- */
        header {
            height: var(--header-h);
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 50;
            flex-shrink: 0;
        }

        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* --- SIDEBAR --- */
        aside {
            width: var(--sidebar-w);
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }
        aside.collapsed { margin-left: calc(var(--sidebar-w) * -1); }
        
        .sidebar-header { padding: 16px; font-weight: 600; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 16px; font-size: 0.9rem; }
        
        .outline-item { margin-bottom: 8px; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .outline-item:hover { color: var(--accent); }
        .outline-item.nested { margin-left: 16px; border-left: 1px solid var(--border); padding-left: 8px; }

        .stat-box { background: var(--bg-app); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.2rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }

        /* Image Controls & Picker */
        .filter-control { margin-bottom: 16px; }
        .filter-control label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-secondary); }
        .filter-control input[type=range] { width: 100%; accent-color: var(--accent); }
        
        .color-swatch-container {
            border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 20px; background: var(--bg-app);
        }
        .color-preview { height: 40px; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .color-value { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .color-label { color: var(--text-secondary); }

        /* --- MAIN VIEW --- */
        main {
            flex: 1;
            overflow: auto;
            position: relative;
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        #document-viewport {
            transform-origin: top center;
            transition: transform 0.1s linear;
            box-shadow: var(--shadow);
            background: var(--bg-paper);
        }

        canvas { display: block; }
        img.doc-image { display: block; max-width: 100%; height: auto; cursor: crosshair; } /* Crosshair para picker */
        
        #text-content {
            padding: 60px 80px;
            width: 800px;
            min-height: 1000px;
            font-size: 16px;
            line-height: 1.8;
            background: #ffffff;
            color: #1e293b;
            white-space: pre-wrap; 
        }
        html.dark #text-content { background: #1e293b; color: #e2e8f0; }

        /* Edit Mode Styles */
        #text-content[contenteditable="true"] {
            outline: 2px dashed var(--accent);
            outline-offset: 10px;
            cursor: text;
        }

        #text-content h1, #text-content h2, #text-content h3 { margin-top: 1.5em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
        #text-content a { color: var(--accent); }
        #text-content blockquote { border-left: 4px solid var(--accent); padding-left: 1em; font-style: italic; color: var(--text-secondary); }
        #text-content img { max-width: 100%; border-radius: 4px; }
        
        /* Search Highlights */
        mark {
            background-color: #fde047; /* Amarillo */
            color: black;
            border-radius: 2px;
            padding: 0 2px;
        }

        /* --- UI COMPONENTS --- */
        .toolbar-group { display: flex; align-items: center; gap: 4px; background: var(--bg-app); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        
        .btn-icon {
            width: 34px; height: 34px; border: none; background: transparent; color: var(--text-secondary);
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-icon:hover:not(:disabled) { background: rgba(128,128,128,0.1); color: var(--text-primary); }
        .btn-icon.active { background: var(--accent); color: white; }
        .btn-icon:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .file-info { margin-left: 12px; display: flex; flex-direction: column; justify-content: center; }
        .file-name { font-weight: 500; font-size: 0.9rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-meta { font-size: 0.75rem; color: var(--text-secondary); }

        #drag-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(59, 130, 246, 0.9); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s; color: white;
            backdrop-filter: blur(5px);
        }
        #drag-overlay.active { opacity: 1; pointer-events: all; }

        /* Floating Search Bar */
        #search-bar {
            position: absolute; top: 80px; right: 40px;
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 8px; border-radius: 8px; box-shadow: var(--shadow);
            display: flex; gap: 8px; align-items: center; z-index: 60;
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #search-input { background: var(--bg-app); border: 1px solid var(--border); color: var(--text-primary); padding: 6px 10px; border-radius: 4px; width: 200px; }

        .hidden { display: none !important; }
        pre[class*="language-"] { border-radius: 8px; margin: 1em 0; border: 1px solid var(--border); }
    </style>
</head>
<body>

    <div id="drag-overlay">
        <span class="material-symbols-rounded" style="font-size: 64px; margin-bottom: 16px;">cloud_upload</span>
        <h2>Suelta tu archivo aquí</h2>
    </div>

    <div id="search-bar" class="hidden">
        <input type="text" id="search-input" placeholder="Buscar..." autocomplete="off">
        <button class="btn-icon" id="btn-do-search" title="Buscar"><span class="material-symbols-rounded">search</span></button>
        <button class="btn-icon" id="btn-close-search" title="Cerrar"><span class="material-symbols-rounded">close</span></button>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <button class="btn-icon" id="toggle-sidebar" title="Menu Lateral">
                <span class="material-symbols-rounded">dock_to_right</span>
            </button>
            <div class="file-info">
                <div class="file-name" id="display-filename">Visor Ultra</div>
                <div class="file-meta" id="display-meta">Esperando archivo...</div>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <div class="toolbar-group hidden" id="group-text">
                <button class="btn-icon" id="btn-edit" title="Editar Texto"><span class="material-symbols-rounded">edit_note</span></button>
                <button class="btn-icon" id="btn-save" title="Guardar (Descargar)" disabled><span class="material-symbols-rounded">save</span></button>
                <div style="width:1px; height:20px; background:var(--border); margin:0 4px;"></div>
                <button class="btn-icon" id="btn-speak" title="Leer en voz alta"><span class="material-symbols-rounded">text_to_speech</span></button>
                <button class="btn-icon" id="btn-search-trigger" title="Buscar (Ctrl+F)"><span class="material-symbols-rounded">find_in_page</span></button>
            </div>

            <div class="toolbar-group hidden" id="group-pdf">
                <button class="btn-icon" id="prev"><span class="material-symbols-rounded">chevron_left</span></button>
                <span style="font-family:'JetBrains Mono'; font-size:0.8rem; padding:0 8px;">
                    <span id="curr-page">0</span>/<span id="total-page">0</span>
                </span>
                <button class="btn-icon" id="next"><span class="material-symbols-rounded">chevron_right</span></button>
            </div>

            <div class="toolbar-group">
                <button class="btn-icon" id="zoom-out"><span class="material-symbols-rounded">remove</span></button>
                <button class="btn-icon" id="zoom-in"><span class="material-symbols-rounded">add</span></button>
            </div>

            <div class="toolbar-group">
                <label class="btn-icon" title="Abrir">
                    <span class="material-symbols-rounded">folder_open</span>
                    <input type="file" id="file-input" hidden accept=".pdf,.json,.txt,.md,.markdown,.png,.jpg,.jpeg,.webp,.svg,.gif">
                </label>
                <button class="btn-icon" id="btn-theme" title="Tema"><span class="material-symbols-rounded">dark_mode</span></button>
            </div>
        </div>
    </header>

    <div class="app-body">
        <aside id="sidebar">
            <div class="sidebar-header">
                <span id="sidebar-title">Información</span>
            </div>
            <div class="sidebar-content" id="sidebar-content">
                <p style="color:var(--text-secondary); text-align:center; margin-top:20px;">No hay datos disponibles</p>
            </div>
        </aside>

        <main id="main-scroll">
            <div id="empty-state" style="text-align:center; margin-top:100px; color:var(--text-secondary);">
                <span class="material-symbols-rounded" style="font-size:64px; opacity:0.3;">dashboard</span>
                <p style="margin-top:16px;">Arrastra un archivo PDF, Imagen, JSON o Texto</p>
            </div>

            <div id="document-viewport" class="hidden">
                <canvas id="pdf-canvas" class="hidden"></canvas>
                <img id="img-content" class="doc-image hidden" alt="Visor Imagen">
                <div id="text-content" class="hidden" spellcheck="false"></div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG & STATE ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const state = {
            doc: null,
            type: null,
            page: 1,
            scale: 1.0,
            pdfScale: 1.5,
            textData: "", // Texto original
            isEditing: false,
            currentFile: null
        };

        const DOM = {
            overlay: document.getElementById('drag-overlay'),
            input: document.getElementById('file-input'),
            filename: document.getElementById('display-filename'),
            filemeta: document.getElementById('display-meta'),
            sidebar: document.getElementById('sidebar'),
            sidebarContent: document.getElementById('sidebar-content'),
            sidebarTitle: document.getElementById('sidebar-title'),
            viewport: document.getElementById('document-viewport'),
            canvas: document.getElementById('pdf-canvas'),
            img: document.getElementById('img-content'),
            text: document.getElementById('text-content'),
            empty: document.getElementById('empty-state'),
            grpPdf: document.getElementById('group-pdf'),
            grpText: document.getElementById('group-text'),
            searchBar: document.getElementById('search-bar'),
            searchInput: document.getElementById('search-input'),
            btnEdit: document.getElementById('btn-edit'),
            btnSave: document.getElementById('btn-save')
        };

        // --- FILE HANDLING ---
        function getFileType(file) {
            const name = file.name.toLowerCase();
            if (name.endsWith('.pdf')) return 'pdf';
            if (/\.(jpg|jpeg|png|webp|gif|svg)$/.test(name)) return 'image';
            if (/\.(json|js|css|html)$/.test(name)) return 'code';
            return 'text';
        }

        async function loadFile(file) {
            if(!file) return;
            resetUI();
            
            DOM.filename.textContent = file.name;
            DOM.filemeta.textContent = `${(file.size / 1024).toFixed(1)} KB`;
            state.type = getFileType(file);
            state.scale = 1.0;
            state.currentFile = file;

            DOM.empty.classList.add('hidden');
            DOM.viewport.classList.remove('hidden');

            try {
                if (state.type === 'pdf') {
                    await handlePDF(file);
                } else if (state.type === 'image') {
                    await handleImage(file);
                } else {
                    await handleText(file);
                }
                applyZoom();
            } catch (e) {
                console.error(e);
                alert("Error al cargar el archivo");
            }
        }

        // --- HANDLERS ---
        async function handlePDF(file) {
            const buffer = await file.arrayBuffer();
            state.doc = await pdfjsLib.getDocument(buffer).promise;
            state.page = 1;
            DOM.canvas.classList.remove('hidden');
            DOM.grpPdf.classList.remove('hidden');
            DOM.sidebarTitle.textContent = "Índice";
            renderPdfPage();
            renderPdfOutline();
        }

        async function renderPdfPage() {
            const page = await state.doc.getPage(state.page);
            const viewport = page.getViewport({ scale: state.pdfScale * state.scale });
            DOM.canvas.width = viewport.width;
            DOM.canvas.height = viewport.height;
            DOM.viewport.style.width = `${viewport.width}px`;
            DOM.viewport.style.transform = 'none';
            await page.render({ canvasContext: DOM.canvas.getContext('2d'), viewport }).promise;
            document.getElementById('curr-page').textContent = state.page;
            document.getElementById('total-page').textContent = state.doc.numPages;
        }

        async function renderPdfOutline() {
            DOM.sidebarContent.innerHTML = '';
            const outline = await state.doc.getOutline();
            if (!outline || outline.length === 0) {
                DOM.sidebarContent.innerHTML = '<p style="color:var(--text-secondary); text-align:center;">Sin índice</p>';
                return;
            }
            const createList = (items) => {
                const ul = document.createElement('div');
                items.forEach(item => {
                    const div = document.createElement('a');
                    div.className = 'outline-item';
                    div.textContent = item.title;
                    div.onclick = async () => {
                        const dest = Array.isArray(item.dest) ? item.dest : await state.doc.getDestination(item.dest);
                        if(dest) {
                            const pageIdx = await state.doc.getPageIndex(dest[0]);
                            state.page = pageIdx + 1;
                            renderPdfPage();
                        }
                    };
                    ul.appendChild(div);
                    if (item.items && item.items.length) {
                        const child = createList(item.items);
                        child.classList.add('nested');
                        ul.appendChild(child);
                    }
                });
                return ul;
            };
            DOM.sidebarContent.appendChild(createList(outline));
        }

        function handleImage(file) {
            DOM.img.classList.remove('hidden');
            DOM.img.src = URL.createObjectURL(file);
            DOM.img.style.filter = 'none'; 
            DOM.sidebarTitle.textContent = "Imagen";
            
            // UI Sidebar: Picker + Filtros
            DOM.sidebarContent.innerHTML = `
                <div class="color-swatch-container">
                    <div style="font-weight:600; font-size:0.8rem; margin-bottom:8px;">Color Picker</div>
                    <div id="picker-preview" class="color-preview" style="background-color: transparent;"></div>
                    <div class="color-value">
                        <span class="color-label">HEX</span>
                        <span id="picker-hex">-</span>
                    </div>
                    <div class="color-value">
                        <span class="color-label">RGB</span>
                        <span id="picker-rgb">-</span>
                    </div>
                    <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:8px; line-height:1.2;">
                        Click en la imagen para copiar el color original del pixel.
                    </div>
                </div>

                <div style="border-top:1px solid var(--border); margin: 16px 0;"></div>
                <div style="font-weight:600; font-size:0.9rem; margin-bottom:12px;">Filtros</div>

                <div class="filter-control">
                    <label>Brillo</label>
                    <input type="range" min="0" max="200" value="100" oninput="applyImgFilter()">
                </div>
                <div class="filter-control">
                    <label>Contraste</label>
                    <input type="range" min="0" max="200" value="100" oninput="applyImgFilter()">
                </div>
                <div class="filter-control">
                    <label>Grises</label>
                    <input type="range" min="0" max="100" value="0" oninput="applyImgFilter()">
                </div>
                <div class="filter-control">
                    <label>Invertir</label>
                    <input type="range" min="0" max="100" value="0" oninput="applyImgFilter()">
                </div>
            `;
        }

        // Logic Color Picker
        DOM.img.onclick = (e) => {
            if (state.type !== 'image') return;
            
            const img = DOM.img;
            // 1. Calcular posición relativa a la imagen mostrada
            const rect = img.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // 2. Escalar posición al tamaño natural de la imagen
            // Esto corrige el zoom o el redimensionamiento CSS
            const scaleX = img.naturalWidth / rect.width;
            const scaleY = img.naturalHeight / rect.height;

            const trueX = Math.floor(x * scaleX);
            const trueY = Math.floor(y * scaleY);

            // 3. Usar un canvas temporal (1x1) para extraer el pixel
            // No dibujamos toda la imagen por rendimiento, solo el trozo necesario
            const canvas = document.createElement('canvas');
            canvas.width = 1;
            canvas.height = 1;
            const ctx = canvas.getContext('2d');
            
            // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
            ctx.drawImage(img, trueX, trueY, 1, 1, 0, 0, 1, 1);
            
            const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;

            // 4. Actualizar UI
            const toHex = (c) => {
                const hex = c.toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            }
            const hexStr = "#" + toHex(r) + toHex(g) + toHex(b);
            const rgbStr = `rgb(${r}, ${g}, ${b})`;

            const preview = document.getElementById('picker-preview');
            const lblHex = document.getElementById('picker-hex');
            const lblRgb = document.getElementById('picker-rgb');

            if(preview) preview.style.backgroundColor = hexStr;
            if(lblHex) lblHex.textContent = hexStr;
            if(lblRgb) lblRgb.textContent = `${r}, ${g}, ${b}`;
        };

        window.applyImgFilter = () => {
            const inputs = DOM.sidebarContent.querySelectorAll('input');
            if(inputs.length < 4) return;
            const b = inputs[0].value;
            const c = inputs[1].value;
            const g = inputs[2].value;
            const i = inputs[3].value;
            DOM.img.style.filter = `brightness(${b}%) contrast(${c}%) grayscale(${g}%) invert(${i}%)`;
        }

        async function handleText(file) {
            const text = await file.text();
            state.textData = text;
            DOM.text.classList.remove('hidden');
            DOM.grpText.classList.remove('hidden');
            DOM.sidebarTitle.textContent = "Estadísticas";

            DOM.text.dataset.raw = text; 
            DOM.text.contentEditable = "false";

            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'json') {
                DOM.text.innerHTML = Prism.highlight(text, Prism.languages.json, 'json');
            } else if (['md', 'markdown'].includes(ext)) {
                // Parseo directo a HTML, sin split view
                DOM.text.innerHTML = marked.parse(text);
            } else if (['js', 'css', 'html'].includes(ext)) {
                DOM.text.innerHTML = Prism.highlight(text, Prism.languages.javascript, 'javascript');
            } else {
                DOM.text.textContent = text;
            }
            
            updateTextStats(text);
        }

        function updateTextStats(text) {
            const words = text.trim().split(/\s+/).length;
            const chars = text.length;
            const lines = text.split(/\r\n|\r|\n/).length;
            DOM.sidebarContent.innerHTML = `
                <div class="stat-box"><div class="stat-label">Palabras</div><div class="stat-value">${words}</div></div>
                <div class="stat-box"><div class="stat-label">Caracteres</div><div class="stat-value">${chars}</div></div>
                <div class="stat-box"><div class="stat-label">Líneas</div><div class="stat-value">${lines}</div></div>
            `;
        }

        // --- FEATURES ---
        DOM.btnEdit.onclick = () => {
            state.isEditing = !state.isEditing;
            DOM.text.contentEditable = state.isEditing;
            DOM.btnEdit.classList.toggle('active');
            DOM.btnSave.disabled = !state.isEditing;

            if (state.isEditing) {
                DOM.text.textContent = DOM.text.dataset.raw;
                DOM.text.focus();
            } else {
                DOM.text.dataset.raw = DOM.text.innerText;
                state.textData = DOM.text.innerText;
                updateTextStats(state.textData);
            }
        };

        DOM.btnSave.onclick = () => {
            const content = DOM.text.innerText;
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "editado_" + (state.currentFile ? state.currentFile.name : "archivo.txt");
            a.click();
            URL.revokeObjectURL(url);
        };

        DOM.btnSearchTrigger = document.getElementById('btn-search-trigger');
        const toggleSearch = () => {
            if (state.type !== 'text' && state.type !== 'code') return;
            DOM.searchBar.classList.toggle('hidden');
            if(!DOM.searchBar.classList.contains('hidden')) DOM.searchInput.focus();
        };
        DOM.btnSearchTrigger.onclick = toggleSearch;
        document.getElementById('btn-close-search').onclick = () => DOM.searchBar.classList.add('hidden');

        document.getElementById('btn-do-search').onclick = executeSearch;
        DOM.searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') executeSearch(); });

        function executeSearch() {
            const query = DOM.searchInput.value;
            if (!query) return;
            const raw = state.textData || DOM.text.textContent;
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            const escaped = raw.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const highlighted = escaped.replace(regex, '<mark>$1</mark>');
            DOM.text.innerHTML = `<pre style="font-family:inherit; white-space:pre-wrap; margin:0;">${highlighted}</pre>`;
        }

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                toggleSearch();
            }
        });

        // --- UTILS & EVENTS ---
        function applyZoom() {
            if (state.type === 'pdf') {
                renderPdfPage();
            } else {
                DOM.viewport.style.transform = `scale(${state.scale})`;
                DOM.viewport.style.marginTop = `${(state.scale - 1) * 100}px`;
                if(state.type === 'image') DOM.viewport.style.width = 'auto';
            }
        }

        function resetUI() {
            DOM.canvas.classList.add('hidden');
            DOM.img.classList.add('hidden');
            DOM.text.classList.add('hidden');
            DOM.grpPdf.classList.add('hidden');
            DOM.grpText.classList.add('hidden');
            DOM.searchBar.classList.add('hidden');
            DOM.viewport.style.width = '';
            DOM.viewport.style.transform = 'none';
            DOM.viewport.style.filter = 'none';
            
            state.isEditing = false;
            DOM.btnEdit.classList.remove('active');
            DOM.btnSave.disabled = true;
            window.speechSynthesis.cancel();
        }

        window.addEventListener('dragover', e => { e.preventDefault(); DOM.overlay.classList.add('active'); });
        window.addEventListener('dragleave', e => { if(!e.relatedTarget) DOM.overlay.classList.remove('active'); });
        window.addEventListener('drop', e => {
            e.preventDefault(); DOM.overlay.classList.remove('active');
            if(e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
        });
        
        DOM.input.addEventListener('change', e => loadFile(e.target.files[0]));
        document.getElementById('zoom-in').onclick = () => { state.scale += 0.1; applyZoom(); };
        document.getElementById('zoom-out').onclick = () => { if(state.scale > 0.2) state.scale -= 0.1; applyZoom(); };
        document.getElementById('prev').onclick = () => { if(state.page > 1) { state.page--; renderPdfPage(); }};
        document.getElementById('next').onclick = () => { if(state.doc && state.page < state.doc.numPages) { state.page++; renderPdfPage(); }};
        document.getElementById('toggle-sidebar').onclick = () => DOM.sidebar.classList.toggle('collapsed');
        document.getElementById('btn-theme').onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('prism-css').href = isDark 
                ? 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css' 
                : 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css';
        };

        document.getElementById('btn-speak').onclick = () => {
            window.speechSynthesis.cancel();
            const textToRead = state.isEditing ? DOM.text.innerText : state.textData;
            const u = new SpeechSynthesisUtterance(textToRead.replace(/[#*`_]/g, ''));
            window.speechSynthesis.speak(u);
        };
    </script>
</body>
</html>